<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Análise Espanha</title>
<link rel="stylesheet" href="style.css">
</head>
<body>
  <div class="container">
    <h1>Análise Espanha</h1>
    <div id="certidoes-container"></div>
    <button onclick="addCertidao()">Adicionar Certidão</button>
    <button class="btn-secondary" onclick="compararCertidoes()">Comparar Certidões</button>
    <button class="btn-danger" onclick="resetar()">Resetar</button>
    <div id="results" class="results"></div>
    <textarea id="exportText" rows="12" readonly></textarea>
    <button class="copy-btn" onclick="copiarTexto()">Copiar Dados</button>
  </div>

  <script>
    const tiposCertidao = ["Nascimento", "Casamento", "Óbito"];
    const relacoesFamiliares = ["Pai", "Mãe", "Filho", "Filha", "Avô Paterno", "Avó Paterna", "Avô Materno", "Avó Materna", "Cônjuge"];

    let certidaoCount = 0;
    let certidoes = [];

    function addCertidao() {
      certidaoCount++;
      const certidaoId = `certidao-${certidaoCount}`;
      const certidaoDiv = document.createElement("div");
      certidaoDiv.className = "certidao";
      certidaoDiv.id = certidaoId;

      certidaoDiv.innerHTML = `
        <h3>
          Certidão ${certidaoCount}
          <button class="btn-danger" onclick="removeCertidao('${certidaoId}')">X</button>
        </h3>
        <div class="form-group">
          <label for="${certidaoId}-tipo">Tipo de Certidão:</label>
          <select id="${certidaoId}-tipo" class="tipo-certidao">
            ${tiposCertidao.map(tipo => `<option value="${tipo}">${tipo}</option>`).join("")}
          </select>
        </div>
        <div class="form-group">
          <label for="${certidaoId}-nome">Nome do Registrado:</label>
          <input type="text" id="${certidaoId}-nome" placeholder="Nome completo">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-nascimento">Data de Nascimento:</label>
          <input type="date" id="${certidaoId}-nascimento">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-pai">Nome do Pai:</label>
          <input type="text" id="${certidaoId}-pai" placeholder="Nome do pai">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-mae">Nome da Mãe:</label>
          <input type="text" id="${certidaoId}-mae" placeholder="Nome da mãe">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-avo-paterno">Avô Paterno:</label>
          <input type="text" id="${certidaoId}-avo-paterno" placeholder="Nome do avô paterno">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-avo-paterna">Avó Paterna:</label>
          <input type="text" id="${certidaoId}-avo-paterna" placeholder="Nome da avó paterna">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-avo-materno">Avô Materno:</label>
          <input type="text" id="${certidaoId}-avo-materno" placeholder="Nome do avô materno">
        </div>
        <div class="form-group">
          <label for="${certidaoId}-avo-materna">Avó Materna:</label>
          <input type="text" id="${certidaoId}-avo-materna" placeholder="Nome da avó materna">
        </div>
        <div class="form-group">
          <label>Relações:</label>
          <div id="${certidaoId}-relacoes"></div>
          <button type="button" onclick="addRelacao('${certidaoId}')">+ Adicionar Relação</button>
        </div>
      `;

      document.getElementById("certidoes-container").appendChild(certidaoDiv);

      certidoes.push({
        id: certidaoId, tipo: tiposCertidao[0],
        nome: "", nascimento: "",
        pai: "", mae: "",
        avoPaterno: "", avoPaterna: "", avoMaterno: "", avoMaterna: "",
        relacoes: []
      });

      updateRelacoesOptions();
    }

    function addRelacao(certidaoId) {
      const relacoesDiv = document.getElementById(`${certidaoId}-relacoes`);
      const relacaoDiv = document.createElement("div");
      relacaoDiv.className = "relacao-item";
      relacaoDiv.innerHTML = `
        <select class="relacao-certidao"></select>
        <select class="relacao-tipo">
          ${relacoesFamiliares.map(r => `<option value="${r}">${r}</option>`).join("")}
        </select>
        <button class="btn-danger" type="button" onclick="this.parentElement.remove()">X</button>
      `;
      relacoesDiv.appendChild(relacaoDiv);
      updateRelacoesOptions();
    }

    function updateRelacoesOptions() {
      document.querySelectorAll(".relacao-certidao").forEach(select => {
        const parentId = select.closest(".certidao").id;
        select.innerHTML = `<option value="">-- Selecione --</option>`;
        certidoes.forEach(c => {
          if (c.id !== parentId) {
            select.innerHTML += `<option value="${c.id}">${c.id}</option>`;
          }
        });
      });
    }

    function removeCertidao(id) {
      if (certidoes.length <= 1) {
        alert("É necessário ter pelo menos uma certidão.");
        return;
      }
      document.getElementById(id).remove();
      certidoes = certidoes.filter(c => c.id !== id);
      updateRelacoesOptions();
    }

    function compararCertidoes() {
      certidoes.forEach(c => {
        c.tipo = document.getElementById(`${c.id}-tipo`).value;
        c.nome = document.getElementById(`${c.id}-nome`).value.trim();
        c.nascimento = document.getElementById(`${c.id}-nascimento`).value;
        c.pai = document.getElementById(`${c.id}-pai`).value.trim();
        c.mae = document.getElementById(`${c.id}-mae`).value.trim();
        c.avoPaterno = document.getElementById(`${c.id}-avo-paterno`).value.trim();
        c.avoPaterna = document.getElementById(`${c.id}-avo-paterna`).value.trim();
        c.avoMaterno = document.getElementById(`${c.id}-avo-materno`).value.trim();
        c.avoMaterna = document.getElementById(`${c.id}-avo-materna`).value.trim();

        c.relacoes = [];
        document.querySelectorAll(`#${c.id}-relacoes .relacao-item`).forEach(div => {
          const relacaoCertidao = div.querySelector(".relacao-certidao").value;
          const relacaoTipo = div.querySelector(".relacao-tipo").value;
          if (relacaoCertidao && relacaoTipo) {
            c.relacoes.push({ com: relacaoCertidao, tipo: relacaoTipo });
          }
        });
      });

      let output = "<h2>Resultados da Comparação:</h2>";
      for (let i = 0; i < certidoes.length; i++) {
        for (let j = i + 1; j < certidoes.length; j++) {
          const c1 = certidoes[i], c2 = certidoes[j];
          output += `<h3>${c1.id} vs ${c2.id}</h3>`;
          output += compararCampos(c1.nome, c2.nome, "Nome");
          output += compararCampos(c1.pai, c2.pai, "Pai");
          output += compararCampos(c1.mae, c2.mae, "Mãe");
          output += compararCampos(c1.avoPaterno, c2.avoPaterno, "Avô Paterno");
          output += compararCampos(c1.avoPaterna, c2.avoPaterna, "Avó Paterna");
          output += compararCampos(c1.avoMaterno, c2.avoMaterno, "Avô Materno");
          output += compararCampos(c1.avoMaterna, c2.avoMaterna, "Avó Materna");
        }
      }

      document.getElementById("results").innerHTML = output;
      gerarTextoExportacao();
    }

    function compararCampos(v1, v2, campo) {
      if (!v1 && !v2) return "";
      const sim = similaridade(v1, v2);
      return `<p><b>${campo}:</b> "${v1}" vs "${v2}" → Similaridade: ${(sim*100).toFixed(1)}%</p>`;
    }

    function similaridade(s1, s2) {
      if (!s1 || !s2) return 0;
      const l1 = s1.toLowerCase(), l2 = s2.toLowerCase();
      const dist = levenshtein(l1, l2);
      return 1 - dist / Math.max(l1.length, l2.length);
    }

    function levenshtein(a, b) {
      const m = a.length, n = b.length;
      const dp = Array.from({length: m+1}, () => Array(n+1).fill(0));
      for (let i=0;i<=m;i++) dp[i][0]=i;
      for (let j=0;j<=n;j++) dp[0][j]=j;
      for (let i=1;i<=m;i++) {
        for (let j=1;j<=n;j++) {
          if (a[i-1]===b[j-1]) dp[i][j]=dp[i-1][j-1];
          else dp[i][j]=1+Math.min(dp[i-1][j],dp[i][j-1],dp[i-1][j-1]);
        }
      }
      return dp[m][n];
    }

    function formatarData(iso) {
      if (!iso) return "";
      const [ano, mes, dia] = iso.split("-");
      return `${dia}/${mes}/${ano}`;
    }

    function gerarTextoExportacao() {
      let texto = "";
      certidoes.forEach((c, i) => {
        texto += `Certidão ${i+1}\n`;
        texto += `Tipo: ${c.tipo}\n`;
        texto += `Nome: ${c.nome}\n`;
        texto += `Data de Nascimento: ${formatarData(c.nascimento)}\n`;
        texto += `Pai: ${c.pai}\n`;
        texto += `Mãe: ${c.mae}\n`;
        texto += `Avô Paterno: ${c.avoPaterno}\n`;
        texto += `Avó Paterna: ${c.avoPaterna}\n`;
        texto += `Avô Materno: ${c.avoMaterno}\n`;
        texto += `Avó Materna: ${c.avoMaterna}\n`;
        if (c.relacoes.length) {
          texto += "Relações:\n";
          c.relacoes.forEach(r => {
            texto += ` - ${r.tipo} de ${r.com}\n`;
          });
        }
        texto += `\n`;
      });
      document.getElementById("exportText").value = texto;
    }

    function copiarTexto() {
      const textarea = document.getElementById("exportText");
      textarea.select();
      document.execCommand("copy");
      alert("Texto copiado!");
    }

    function resetar() {
      if (confirm("Deseja limpar tudo?")) {
        document.getElementById("certidoes-container").innerHTML = "";
        document.getElementById("results").innerHTML = "";
        document.getElementById("exportText").value = "";
        certidoes = [];
        certidaoCount = 0;
        addCertidao();
      }
    }

    // inicia com 1 certidão
    addCertidao();
  </script>
</body>
</html>